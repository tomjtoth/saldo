// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Meta {
  id   Int    @id @default(autoincrement())
  info String @unique
  data Bytes?

  @@ignore
}

// SED-MARKER

model Archive {
  id            Int    @id @default(autoincrement())
  tableColumnId Int
  entityPk1     Int
  entityPk2     Int?
  revisionId    Int
  data          Bytes?

  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)
}

model Revision {
  id           Int @id @default(autoincrement())
  createdAtInt Int @map("createdAt")
  createdById  Int @map("createdBy")

  createdBy   User         @relation("createdByUser", fields: [createdById], references: [id], onDelete: NoAction)
  users       User[]
  groups      Group[]
  memberships Membership[]
  categories  Category[]
  receipts    Receipt[]
  items       Item[]
  itemShares  ItemShare[]
  archives    Archive[]
}

model User {
  id             Int     @id @default(autoincrement())
  revisionId     Int
  statusId       Int     @default(0)
  email          String
  name           String?
  image          String?
  defaultGroupId Int?

  revision         Revision     @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  createdRevisions Revision[]   @relation("createdByUser")
  memberships      Membership[]
  defaultGroup     Group?       @relation("defaultGroup", fields: [defaultGroupId], references: [id], onDelete: NoAction)
  itemShares       ItemShare[]
  receipts         Receipt[]
}

model Group {
  id          Int     @id @default(autoincrement())
  revisionId  Int
  statusId    Int     @default(0)
  name        String
  description String?
  uuid        String?

  revision        Revision     @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  memberships     Membership[]
  categories      Category[]
  receipts        Receipt[]
  defaultingUsers User[]       @relation("defaultGroup")
}

model Membership {
  userId            Int
  groupId           Int
  revisionId        Int
  statusId          Int  @default(0)
  defaultCategoryId Int?

  revision        Revision  @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: NoAction)
  group           Group     @relation(fields: [groupId], references: [id], onDelete: NoAction)
  defaultCategory Category? @relation(fields: [defaultCategoryId], references: [id], onDelete: NoAction)

  @@id([userId, groupId])
}

model Category {
  id          Int     @id @default(autoincrement())
  revisionId  Int
  statusId    Int     @default(0)
  groupId     Int
  name        String
  description String?

  revision              Revision     @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  group                 Group        @relation(fields: [groupId], references: [id], onDelete: NoAction)
  defaultingMemberships Membership[]
  items                 Item[]
}

model Receipt {
  id         Int @id @default(autoincrement())
  revisionId Int
  statusId   Int @default(0)
  groupId    Int
  paidById   Int @map("paidBy")
  paidOnInt  Int @map("paidOn")

  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  group    Group    @relation(fields: [groupId], references: [id], onDelete: NoAction)
  items    Item[]
  paidBy   User     @relation(fields: [paidById], references: [id], onDelete: NoAction)
}

model Item {
  id         Int     @id @default(autoincrement())
  revisionId Int
  statusId   Int     @default(0)
  receiptId  Int
  categoryId Int
  cost       Int
  notes      String?

  revision   Revision    @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  receipt    Receipt     @relation(fields: [receiptId], references: [id], onDelete: NoAction)
  category   Category    @relation(fields: [categoryId], references: [id], onDelete: NoAction)
  itemShares ItemShare[]
}

model ItemShare {
  itemId     Int
  userId     Int
  revisionId Int
  statusId   Int @default(0)
  share      Int

  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id], onDelete: NoAction)
  user     User     @relation(fields: [userId], references: [id], onDelete: NoAction)

  @@id([itemId, userId])
}
