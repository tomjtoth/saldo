name: CI/CD pipeline

on:
  push:
    branches:
      - dev
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-build-test:
    name: Lint, Build and Test
    env:
      SKIP_CI: ${{ contains(github.event.head_commit.message, '#skip-ci') || contains(github.event.pull_request.title, '#skip-ci') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        if: env.SKIP_CI != 'true'
        uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        if: env.SKIP_CI != 'true'
        with:
          node-version: latest

      - name: Install node_modules, lint and build
        if: env.SKIP_CI != 'true'
        run: |
          npm ci
          npm run lint
          npm run build

      - name: Run tests and generate coverage report
        if: env.SKIP_CI != 'true'
        run: |
          export AUTH_SECRET=$(uuidgen)
          npm run coverage:unit
          npm run e2e:headless
          npm run coverage:report

      - name: Upload results to Codecov
        if: env.SKIP_CI != 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  gen-tags:
    name: Generate tags
    runs-on: ubuntu-latest
    needs: lint-build-test
    outputs:
      tags: ${{ steps.set_tags.outputs.tags }}

    if: >
      github.event_name == 'push'
      && github.ref_name != 'dev'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate tags
        id: set_tags
        run: |
          git fetch --tags || true

          TAG=$(cat package.json | jq -r '.version')
          echo "Found package.json version: $TAG"

          if ! git tag --list | grep -qx "v$TAG"; then
            # publish all semvers "X.Y.Z" + "X.Y" + "X"
            TAGS=($TAG ${TAG%.*} ${TAG%%.*})

            BRANCH=${{ github.ref_name }}
            if [[ $BRANCH == main ]]; then
              echo "‚ö†Ô∏è adding the **latest** tag"
              TAGS+=(latest)
            else
              TAGS+=($BRANCH)
            fi

            # write multi-line output
            {
              echo 'tags<<EOF'
              printf 'tomjtoth/saldo:%s\n' "${TAGS[@]}"
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            printf '%s\n' \
              "‚úÖ Generated tags:" \
              "  ${TAGS[*]}"
          else
            echo "tags=" >> $GITHUB_OUTPUT

            printf '%s\n' \
              "‚ùå No tags generated:" \
              "  v$TAG is already present in repo."
          fi

  build-image:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: gen-tags
    if: needs.gen-tags.outputs.tags != ''

    steps:
      - name: Decide if build is needed
        run: |
          TAGS=(${{ needs.gen-tags.outputs.tags }})

          if docker manifest inspect ${TAGS[0]} > /dev/null 2>&1; then
            echo "‚úÖ Image ${TAGS[0]} already exists, skipping build"
            echo "SKIP_BUILD=1" >> $GITHUB_ENV
          fi

      - name: Checkout
        if: env.SKIP_BUILD != '1'
        uses: actions/checkout@v6

      - name: Set up QEMU
        if: env.SKIP_BUILD != '1'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: env.SKIP_BUILD != '1'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: env.SKIP_BUILD != '1'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image
        if: env.SKIP_BUILD != '1'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          load: true # load image into local docker so we can inspect
          push: false
          tags: |
            ${{ needs.gen-tags.outputs.tags }}
          build-args: |
            GIT_HASH=${{ github.sha }}
          cache-from: type=gha,scope=shared
          cache-to: type=gha,mode=max,scope=shared

      - name: Check image size
        if: env.SKIP_BUILD != '1'
        run: |
          TAGS=(${{ needs.gen-tags.outputs.tags }})
          SIZE_BYTES=$(docker image inspect ${TAGS[0]} --format='{{.Size}}')
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          MAX_SIZE_MB=300

          if [ "$SIZE_MB" -gt "$MAX_SIZE_MB" ]; then
            echo "üìà Docker image exceeds ${MAX_SIZE_MB} MB (got ${SIZE_MB} MB)"
            exit 1
          else
            echo "Image size: ${SIZE_MB} MB"
          fi

      - name: Push image
        if: env.SKIP_BUILD != '1'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: |
            ${{ needs.gen-tags.outputs.tags }}
          build-args: |
            GIT_HASH=${{ github.sha }}
          cache-from: type=gha,scope=shared
          cache-to: type=gha,mode=max,scope=shared

  gitops:
    name: Kustomize cluster
    runs-on: ubuntu-latest
    needs:
      - gen-tags
      - build-image
    steps:
      - name: GitOps in repo `vps`
        run: |
          # Clone the vps repo
          git clone https://x-access-token:${{ secrets.VPS_REPO_PAT }}@github.com/tomjtoth/vps.git /tmp/vps
          cd /tmp/vps

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          TAGS=(${{ needs.gen-tags.outputs.tags }})

          for tag in ${TAGS[@]}; do
            # trim repo
            tag=${tag#*:}
            
            if [ $tag == "latest" ]; then
              tag=prod
            fi

            echo "  DEBUG: checking $tag"
            K_FILE="apps/saldo/$tag/kustomization.yml"
            if [ -f "$K_FILE" ]; then
              K_FILES+=("$K_FILE")
              echo "‚ö†Ô∏è bumping $tag"
            fi
          done

          for k in "${K_FILES[@]}"; do
            yq e '(.images[] | select(.name=="IMAGES/APP")).newName = "'"${TAGS[0]}"'"' -i "$k"
            git add "$k"
          done

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No changes to commit"
          else
            count=${#K_FILES[@]}
            msg="Updated $count image"
            if [ $count -gt 1 ]; then
              msg+=s
            fi

            git commit -m "$msg"
            git push origin main
            echo "‚úÖ $msg"
          fi

  rel-tag:
    name: Release new tag to repo
    needs:
      - gen-tags
      - gitops
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create tag
        run: |
          TAGS=(${{ needs.gen-tags.outputs.tags }})
          TAG=v${TAGS[0]#*:}

          # create annotated tag and push it back to the repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
